/* ===== LB-K SMART 2026 - CORE ENGINE ===== */

document.addEventListener('DOMContentLoaded', function() {
    
    // --- 1. CONFIGURATION & DONN√âES SIMUL√âES ---
    const APP_STATE = {
        cart: [],
        products: [
            { id: 1, name: "Parac√©tamol 500mg", price: 1500, category: "pharmacie", image: "üíä" },
            { id: 2, name: "Chemise Slim Fit", price: 15000, category: "habillement", image: "üëî" },
            { id: 3, name: "iPhone 15 Pro", price: 2500000, category: "electronique", image: "üì±" },
            { id: 4, name: "Mixeur Smart", price: 45000, category: "electromenager", image: "üå™Ô∏è" },
            { id: 5, name: "Fond de teint Bio", price: 8000, category: "cosmetiques", image: "‚ú®" },
            { id: 6, name: "Filtre √† huile Toyota", price: 6500, category: "auto-pieces", image: "üîß" },
            { id: 7, name: "MacBook Air M2", price: 1800000, category: "electronique", image: "üíª" },
            { id: 8, name: "Amoxicilline", price: 2500, category: "pharmacie", image: "üíä" }
        ]
    };

    // --- 2. GESTION DE LA NAVIGATION ---
    const navBtns = document.querySelectorAll('.nav-btn');
    const sections = document.querySelectorAll('.content-section');

    navBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            // Retirer active de tous les boutons
            navBtns.forEach(b => b.classList.remove('active'));
            // Ajouter active au bouton cliqu√©
            btn.classList.add('active');
            
            // Cacher toutes les sections
            sections.forEach(s => s.classList.remove('active'));
            
            // Afficher la section cible
            const targetId = btn.getAttribute('data-section') + 'Section';
            const targetSection = document.getElementById(targetId);
            if(targetSection) targetSection.classList.add('active');

            // Animation sp√©ciale pour le bureau
            if(btn.getAttribute('data-section') === 'bureau') {
                initBureau();
            }
        });
    });

    // --- 3. CATALOGUE & FILTRES ---
    const catalogueGrid = document.getElementById('catalogueGrid');
    const categoryFilters = document.querySelectorAll('.cat-filter');

    function renderProducts(filter = 'all') {
        catalogueGrid.innerHTML = '';
        
        const filtered = filter === 'all' 
            ? APP_STATE.products 
            : APP_STATE.products.filter(p => p.category === filter);

        if(filtered.length === 0) {
            catalogueGrid.innerHTML = '<div class="empty-catalogue"><p>Aucun produit trouv√©.</p></div>';
            return;
        }

        filtered.forEach(product => {
            const card = document.createElement('div');
            card.className = 'product-card';
            // Style inline pour la d√©mo, id√©alement dans le CSS
            card.style.cssText = `
                background: white; padding: 1rem; border-radius: 12px; 
                box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s;
                display: flex; flex-direction: column; gap: 10px;
            `;
            
            card.innerHTML = `
                <div style="font-size: 3rem; text-align: center; background: #f0f2f5; border-radius: 8px; padding: 1rem;">
                    ${product.image}
                </div>
                <h4 style="margin:0;">${product.name}</h4>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="color:#1a73e8; font-weight:bold;">${product.price.toLocaleString()} FCFA</span>
                    <button class="add-btn" data-id="${product.id}" style="
                        background:var(--primary-color); color:white; border:none; 
                        width:32px; height:32px; border-radius:50%; cursor:pointer;">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            `;
            catalogueGrid.appendChild(card);
        });

        // Attacher les √©v√©nements d'ajout au panier
        document.querySelectorAll('.add-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = parseInt(e.currentTarget.getAttribute('data-id'));
                addToCart(id);
                // Petit effet visuel
                e.currentTarget.style.transform = "scale(1.2)";
                setTimeout(() => e.currentTarget.style.transform = "scale(1)", 200);
            });
        });
    }

    // Gestion des filtres
    categoryFilters.forEach(filterBtn => {
        filterBtn.addEventListener('click', () => {
            categoryFilters.forEach(b => b.classList.remove('active'));
            filterBtn.classList.add('active');
            renderProducts(filterBtn.getAttribute('data-category'));
        });
    });

    // --- 4. PANIER INTELLIGENT ---
    function addToCart(id) {
        const product = APP_STATE.products.find(p => p.id === id);
        APP_STATE.cart.push(product);
        updateCartUI();
        showNotification(`${product.name} ajout√© au panier`, 'success');
    }

    function updateCartUI() {
        const count = APP_STATE.cart.length;
        const total = APP_STATE.cart.reduce((sum, p) => sum + p.price, 0);
        
        // Mise √† jour des compteurs
        document.querySelectorAll('.cart-count').forEach(el => el.textContent = count);
        document.querySelectorAll('.cart-badge').forEach(el => el.textContent = count);
        
        // Mise √† jour de la liste flottante
        const previewItems = document.getElementById('cartPreviewItems');
        if(previewItems) {
            previewItems.innerHTML = APP_STATE.cart.map(p => `
                <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:14px;">
                    <span>${p.name}</span>
                    <b>${p.price} FC</b>
                </div>
            `).join('');
        }
        
        // Mise √† jour du total
        const totalElements = document.querySelectorAll('.total-amount');
        totalElements.forEach(el => el.textContent = `${total.toLocaleString()} FCFA`);
        
        // Mise √† jour section panier principal
        const panierContainer = document.getElementById('smartCartContainer');
        if(count > 0) {
            panierContainer.innerHTML = `
                <div style="background:white; padding:2rem; border-radius:12px;">
                    <h3>Votre commande (${count} articles)</h3>
                    ${APP_STATE.cart.map(p => `<div style="padding:10px; border-bottom:1px solid #eee;">${p.image} ${p.name} - <b>${p.price} FCFA</b></div>`).join('')}
                    <div style="margin-top:20px; font-size:1.2rem; font-weight:bold;">Total: ${total.toLocaleString()} FCFA</div>
                    <button id="mainCheckoutBtn" style="background:#25D366; color:white; border:none; padding:15px; width:100%; margin-top:15px; border-radius:8px; font-weight:bold; font-size:16px; cursor:pointer;">
                        <i class="fab fa-whatsapp"></i> Finaliser sur WhatsApp
                    </button>
                    <button onclick="APP_STATE.cart=[]; updateCartUI();" style="margin-top:10px; background:none; border:none; color:red; cursor:pointer; width:100%;">Vider le panier</button>
                </div>
            `;
            
            // Attacher l'√©v√©nement checkout
            document.getElementById('mainCheckoutBtn').addEventListener('click', checkoutWhatsApp);
        } else {
            panierContainer.innerHTML = `
                <div class="empty-panier">
                    <i class="fas fa-shopping-cart" style="font-size:3rem; color:#ccc;"></i>
                    <h3>Votre panier est vide</h3>
                </div>
            `;
        }
    }

    function checkoutWhatsApp() {
        if(APP_STATE.cart.length === 0) return;
        
        let message = "üëã Bonjour LB-K SMART, je voudrais commander :\n\n";
        APP_STATE.cart.forEach(p => {
            message += `- ${p.name} (${p.price} FCFA)\n`;
        });
        const total = APP_STATE.cart.reduce((sum, p) => sum + p.price, 0);
        message += `\nüí∞ *TOTAL: ${total.toLocaleString()} FCFA*`;
        
        const url = `https://wa.me/243822937321?text=${encodeURIComponent(message)}`;
        window.open(url, '_blank');
    }

    // --- 5. TERMINAL & ADMIN ---
    const terminalOutput = document.getElementById('terminalOutput');
    document.querySelector('.run-code-btn').addEventListener('click', () => {
        const code = document.getElementById('codeEditor').value;
        const line = document.createElement('div');
        line.className = 'output-line';
        line.innerHTML = `<span style="color:#fbbc04;">> Ex√©cution...</span>`;
        terminalOutput.appendChild(line);
        
        setTimeout(() => {
            const resultLine = document.createElement('div');
            resultLine.className = 'output-line success';
            resultLine.innerHTML = `‚úì Code compil√© avec succ√®s (Simulation).`;
            terminalOutput.appendChild(resultLine);
            terminalOutput.scrollTop = terminalOutput.scrollHeight;
        }, 800);
    });

    document.querySelector('.admin-login-btn').addEventListener('click', () => {
        const pass = document.querySelector('.admin-password').value;
        if(pass === "admin2026") { // Mot de passe d√©mo
            document.getElementById('adminPanel').style.display = "grid";
            showNotification("Acc√®s administrateur accord√©", "success");
        } else {
            showNotification("Acc√®s refus√©: Mot de passe incorrect", "error");
        }
    });

    // --- 6. ASSISTANT IA (Simulation) ---
    const aiInput = document.querySelector('.ai-input input');
    const aiSend = document.querySelector('.ai-send-btn');
    const aiChat = document.querySelector('.ai-chat');

    function addAiMessage(text, sender = 'bot') {
        const div = document.createElement('div');
        div.className = 'ai-message';
        div.style.background = sender === 'user' ? '#e8f0fe' : '#f8f9fa';
        div.style.textAlign = sender === 'user' ? 'right' : 'left';
        div.innerHTML = `
            <div class="message-content">${text}</div>
            <div class="message-time" style="font-size:10px; color:#999;">√Ä l'instant</div>
        `;
        aiChat.appendChild(div);
        aiChat.scrollTop = aiChat.scrollHeight;
    }

    aiSend.addEventListener('click', () => {
        const text = aiInput.value;
        if(!text) return;
        
        addAiMessage(text, 'user');
        aiInput.value = '';

        // R√©ponse simul√©e IA
        setTimeout(() => {
            let response = "Je peux vous aider √† naviguer dans le catalogue.";
            if(text.toLowerCase().includes('stock')) response = "Le stock est mis √† jour en temps r√©el. Quel produit cherchez-vous ?";
            if(text.toLowerCase().includes('prix')) response = "Nos prix sont en FCFA et comp√©titifs pour Kinshasa.";
            if(text.toLowerCase().includes('livraison')) response = "Nous livrons √† domicile sur Kinshasa et exp√©dions en province.";
            
            addAiMessage(response, 'bot');
        }, 1000);
    });

    // --- 7. UTILITAIRES ---
    function showNotification(msg, type) {
        const container = document.getElementById('notificationContainer');
        const notif = document.createElement('div');
        notif.className = `notification ${type}`;
        notif.innerHTML = `<i class="fas fa-info-circle"></i> <span>${msg}</span>`;
        container.appendChild(notif);
        setTimeout(() => notif.remove(), 3000);
    }

    function initBureau() {
        // Simulation du chargement du bureau
        const bureau = document.getElementById('bureauRoot');
        bureau.innerHTML = `
            <div style="padding:2rem; text-align:center;">
                <h2 style="color:var(--primary-color);">Bienvenue Laurent & Betty</h2>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-top:30px;">
                    <div style="background:#e3f2fd; padding:20px; border-radius:12px;">
                        <h3>${new Date().toLocaleTimeString()}</h3>
                        <p>Heure locale</p>
                    </div>
                    <div style="background:#e8f5e9; padding:20px; border-radius:12px;">
                        <h3>${APP_STATE.cart.length}</h3>
                        <p>Articles panier actif</p>
                    </div>
                    <div style="background:#fff3e0; padding:20px; border-radius:12px;">
                        <h3>En ligne</h3>
                        <p>Statut Syst√®me</p>
                    </div>
                </div>
            </div>
        `;
    }

    // Initialisation
    console.log("LB-K SMART Engine Started");
    renderProducts();
    
    // Toggle Panier Flottant
    document.querySelector('.cart-icon').addEventListener('click', () => {
        const preview = document.querySelector('.cart-preview');
        preview.style.display = preview.style.display === 'block' ? 'none' : 'block';
    });
    
    // Toggle Assistant IA
    document.querySelector('.help-btn').addEventListener('click', () => {
        const ai = document.getElementById('aiAssistant');
        ai.style.display = 'block';
    });
    document.querySelector('.ai-close-btn').addEventListener('click', () => {
        document.getElementById('aiAssistant').style.display = 'none';
    });
});
